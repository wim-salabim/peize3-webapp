<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Peize 3 WebApp</title>
    <style>
        :root{
          --bg:#0f172a;
          --card:#111827;
          --muted:#334155;
          --text:#e5e7eb;
          --accent:#22c55e;
          --accent-2:#60a5fa;
          --danger:#ef4444;
          --warn:#f59e0b;
          --border:#1f2937;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
        a{color:inherit}
        .wrap{max-width:1100px;margin:0 auto;padding:20px}
        header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#0b1220;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border)}
        .brand{font-weight:700;letter-spacing:.3px}
        nav{display:flex;flex-wrap:wrap;gap:8px}
        .btn{padding:8px 12px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;cursor:pointer}
        .btn:hover{filter:brightness(1.15)}
        .btn.primary{background:linear-gradient(135deg,var(--accent-2),var(--accent));border-color:transparent;color:#0b1220;font-weight:600}
        .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);border-color:transparent;color:white}
        .btn.warn{background:linear-gradient(135deg,#f59e0b,#b45309);border-color:transparent;color:white}
        .btn.ghost{background:transparent}
        .chip{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0b1220;font-size:.8rem;opacity:.9}
        .row{display:flex;gap:16px;align-items:stretch}
        .col{flex:1}
        .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
        .muted{color:#cbd5e1;opacity:.9}
        .subtle{color:#9ca3af}
        .section{display:none;margin-top:18px}
        .section.active{display:block}
        h1,h2,h3{margin:.2rem 0 .7rem}
        h1{font-size:1.4rem}
        h2{font-size:1.2rem}
        h3{font-size:1.05rem}
        input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
        label{display:block;font-size:.92rem;margin:8px 0 6px}
        table{width:100%;border-collapse:collapse}
        td,th{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;font-size:.95rem}
        tr:hover{background:#0b1220}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:.8rem}
        .hidden{display:none !important}
        .sticky-actions{position:sticky;bottom:0;display:flex;gap:10px;padding-top:10px}
        .tabbar{display:flex;gap:8px;margin:4px 0 12px}
        .tabbar .btn{padding:6px 10px}
        .note{font-size:.9rem;color:#cbd5e1}
        .divider{height:1px;background:var(--border);margin:8px 0 12px}
        .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1220;border:1px solid var(--border);padding:6px 8px;border-radius:8px}
        .kpi{font-weight:700;font-size:1.4rem}
        .tag{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;background:#0b1220;border:1px solid var(--border);border-radius:999px;font-size:.8rem}
        .list{display:flex;flex-direction:column;gap:10px}
        .vote-row{display:flex;gap:8px;align-items:center}
        .vote-box{border:1px dashed var(--border);border-radius:12px;padding:10px}
        .reveal-box{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:10px}
        .status-dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
        .st-active{background:#22c55e}.st-closed{background:#f59e0b}.st-revealing{background:#60a5fa}.st-released{background:#a78bfa}
        .help{font-size:.85rem;color:#9ca3af}
        .nowrap{white-space:nowrap}
        .tight td{padding:6px 4px}
        #tbl-stats th { cursor:pointer; }
        #tbl-stats th.asc::after { content:" â–²"; }
        #tbl-stats th.desc::after { content:" â–¼"; }
        #tbl-klassement th { cursor:pointer; }
        #tbl-klassement th.asc::after { content:" â–²"; }
        #tbl-klassement th.desc::after { content:" â–¼"; }
        #kpi-scorers, #kpi-assists, #kpi-kut, #kpi-king, #kpi-bonanza { margin:4px 0; padding-left:18px; }
        #kpi-scorers li, #kpi-assists li, #kpi-kut li, #kpi-king li, #kpi-bonanza li { margin:2px 0; }
        #presence-box label {
          display: inline-flex;      /* compacte inline flex, niet full-width */
          align-items: center;
          gap: 6px;
          white-space: nowrap;       /* tekst mag niet afbreken */
        }

        #presence-box {
          display: flex;             /* lijst van spelers onder elkaar */
          flex-direction: column;
          gap: 6px;                  /* beetje ruimte ertussen */
        }

        #presence-box input[type="checkbox"] {
          margin: 0;       /* haalt de standaard-inspringing weg */
        }3
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Zorg dat de tabel z'n normale layout behoudt */
        .table-wrapper table {
            min-width: 600px; /* of meer, afhankelijk van aantal kolommen */
            border-collapse: collapse;
        }

        /* ðŸ“± Responsive fixes */
        @media (max-width: 768px) {
          /* Zet rijen onder elkaar op mobiel */
          .row {
            flex-direction: column;
          }

          /* Buttons in nav compacter en in meerdere regels */
          header nav {
            flex-wrap: wrap;
            gap: 6px;
          }

          header .btn {
            flex: initial;      /* geen forceren */
            min-width: unset;   /* vaste breedte weg */
          }

          /* Optioneel: horizontaal scrollbare nav */
          header nav {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
          }

          /* Grid-items vol-breed op heel smal scherm */
          .grid {
            grid-template-columns: 1fr;
          }
        }
    </style>
</head>
<body>
<header>
    <div class="brand">âš½ Peize 3 WebApp</div>
    <nav id="nav">
        <button class="btn" data-go="home">Home</button>
        <button class="btn" data-go="matches">Wedstrijden</button>
        <button class="btn" data-go="stats">Statistieken</button>
        <button class="btn" data-go="klassement">Klassement</button>
        <button class="btn" data-go="voting">Stemmen</button>
        <span id="nav-admin" class="hidden">
        <button class="btn" data-go="admin">Beheer</button>
      </span>
        <span id="nav-auth">
        <button class="btn primary" data-go="login">Inloggen</button>
      </span>
        <span id="nav-user" class="hidden">
        <span class="chip" id="chip-user">â€¢</span>
        <button class="btn ghost" id="btn-logout">Uitloggen</button>
      </span>
    </nav>
</header>

<div class="wrap">
    <!-- HOME -->
    <section id="home" class="section active">
        <div class="row">
            <div class="col card">
                <h1>Welkom</h1>
                <div class="divider"></div>
                <div class="grid">
                    <div class="card">
                        <div class="kpi">Gespeelde wedstrijden</div>
                        <div class="subtle">Winst: <span id="home-wins">0</span></div>
                        <div class="subtle">Gelijk: <span id="home-draws">0</span></div>
                        <div class="subtle">Verlies: <span id="home-losses">0</span></div>
                        <br>
                        <div class="kpi">Aantal punten: <span id="home-points">0</span></div>
                    </div>
                    <div class="card">
                        <div class="kpi">Top 3 - Topscorer</div>
                        <div class="subtle"><ol id="kpi-scorers">0</ol></div>
                    </div>
                    <div class="card">
                        <div class="kpi">Top 3 - Assists</div>
                        <div class="subtle"><ol id="kpi-assists">0</ol></div>
                    </div>
                    <div class="card">
                        <div class="kpi">Top 3 - King</div>
                        <div class="subtle"><span id="kpi-king">0</span></div>
                    </div>
                    <div class="card">
                        <div class="kpi">Top 3 - Kut</div>
                        <div class="subtle"><span id="kpi-kut">0</span></div>
                    </div>
                    <div class="card">
                        <div class="kpi">Top 3 - Bonanza</div>
                        <div class="subtle"><span id="kpi-bonanza">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MATCHES (Programma / Uitslagen) -->
    <section id="matches" class="section">
        <div class="card">
            <h1>Wedstrijden</h1>
            <div class="tabbar">
                <button class="btn" id="tab-programma">Programma</button>
                <button class="btn" id="tab-uitslagen">Uitslagen</button>
            </div>
            <div id="programma-list" class="list"></div>
            <div id="uitslagen-list" class="list hidden"></div>
        </div>
    </section>

    <!-- STATS -->
    <section id="stats" class="section">
        <div class="card">
            <h1>Statistieken</h1>
            <div class="table-wrapper">
                <table id="tbl-stats" class="tight">
                    <thead><tr><th>Speler</th><th>Positie</th><th>Gespeelde wedstrijden</th><th>Doelpunten</th><th>Assists</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- KKB-KLASSEMENT -->
    <section id="klassement" class="section">
        <div class="card">
            <h1>King-Kut-Bonanza Klassement</h1>
            <div class="divider"></div>
            <div class="table-wrapper">
                <table id="tbl-klassement" class="tight">
                    <thead><tr><th>Speler</th><th>King-Stemmen</th><th>Kut-Stemmen</th><th>Bonanza-Stemmen</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- VOTING (voor gebruikers) -->
    <section id="voting" class="section">
        <div class="card">
            <h1>Stemmen</h1>
            <div id="vote-active-list" class="list"></div>
            <div class="divider"></div>
            <h2>Vrijgegeven resultaten</h2>
            <div id="vote-released-list" class="list"></div>
        </div>
    </section>

    <!-- LOGIN -->
    <section id="login" class="section">
        <div class="row">
            <div class="col card">
                <h1>Inloggen</h1>
                <label>Gebruikersnaam</label>
                <input id="login-user" placeholder="bijv. admin"/>
                <label>Wachtwoord</label>
                <input id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/>
                <div class="sticky-actions">
                    <button id="btn-login" class="btn primary">Inloggen</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="section">
        <div class="card">
            <h1>Beheer</h1>
            <div class="tabbar">
                <button class="btn" data-adtab="users">Gebruikers</button>
                <button class="btn" data-adtab="players">Spelers</button>
                <button class="btn" data-adtab="matches">Wedstrijden</button>
                <button class="btn" data-adtab="votes">Stemmingen</button>
            </div>

            <!-- USERS TAB -->
            <div id="ad-users" class="adtab">
                <div class="row">
                    <div class="col card">
                        <h2>Nieuwe gebruiker</h2>
                        <label>Gebruikersnaam</label><input id="new-usr-name"/>
                        <label>Wachtwoord</label><input id="new-usr-pass" type="password"/>
                        <label>Rol</label>
                        <select id="new-usr-role">
                            <option value="user">user</option>
                            <option value="stemmen_lezer">stemmen_lezer</option> <!-- >>> STEMMEN LEZER ROL -->
                            <option value="moderator">moderator</option>
                        </select>
                        <div class="sticky-actions">
                            <button class="btn primary" id="btn-add-user">Toevoegen</button>
                        </div>
                    </div>
                    <div class="col card">
                        <h2>Bestaande gebruikers</h2>
                        <div class="table-wrapper">
                            <table id="tbl-users">
                                <thead><tr><th>Naam</th><th>Rol</th><th>Wijzig</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PLAYERS TAB -->
            <div id="ad-players" class="adtab hidden">
                <div class="row">
                    <div class="col card">
                        <h2>Speler toevoegen / bewerken</h2>
                        <input type="hidden" id="edit-player-id">
                        <label>Naam</label><input id="pl-name"/>
                        <label>Positie</label><input id="pl-pos"/>
                        <div class="sticky-actions">
                            <button class="btn primary" id="btn-save-player">Opslaan</button>
                            <button class="btn ghost" id="btn-cancel-player">Annuleren</button>
                        </div>
                    </div>
                    <div class="col card">
                        <h2>Spelers</h2>
                        <div class="table-wrapper">
                            <table id="tbl-players" class="tight">
                                <thead><tr><th>Naam</th><th>Positie</th><th>Acties</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MATCHES TAB -->
            <div id="ad-matches" class="adtab hidden">
                <div class="row">
                    <div class="col card">
                        <h2>Wedstrijd toevoegen / bewerken</h2>
                        <input type="hidden" id="edit-match-id">
                        <label>Tegenstander</label><input id="mt-opponent"/>
                        <label>Datum & tijd</label><input id="mt-date" type="datetime-local"/>
                        <label>Locatie</label><input id="mt-location" placeholder="optioneel"/>
                        <label>Uitslag (onze goals)</label><input id="mt-gfor" type="number" min="0" placeholder="leeg laten als nog niet gespeeld"/>
                        <label>Uitslag (tegenstander goals)</label><input id="mt-gagn" type="number" min="0" placeholder=""/>
                        <div class="divider"></div>
                        <h3>Doelpunten</h3>
                        <div id="goals-box" class="list"></div>
                        <button type="button" class="btn" id="btn-add-goal">âž• Doelpunt toevoegen</button>
                        <label>Verslag</label><textarea id="mt-report" rows="3" placeholder="wedstrijdverslag (optioneel)"></textarea>
                        <div class="divider"></div>
                        <h3>Aanwezige spelers</h3>
                        <div id="presence-box" class="grid"></div>
                        <div class="sticky-actions">
                            <button class="btn primary" id="btn-save-match">Opslaan</button>
                            <button class="btn ghost" id="btn-cancel-match">Annuleren</button>
                        </div>
                    </div>
                    <div class="col card">
                        <h2>Wedstrijden</h2>
                        <div class="table-wrapper">
                            <table id="tbl-matches">
                                <thead><tr><th>Datum</th><th>Tegenstander</th><th>Uitslag</th><th>Acties</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VOTES TAB -->
            <div id="ad-votes" class="adtab hidden">
                <div class="row">
                    <div class="col card">
                        <h2>Nieuwe stemming</h2>
                        <label>Titel</label><input id="vt-title" placeholder="bv. Stemming speelronde 5"/>
                        <label>Wedstrijd</label>
                        <select id="vt-match"></select>
                        <div class="sticky-actions">
                            <button class="btn primary" id="btn-add-vote">Stemming starten</button>
                        </div>
                        <div class="help">Stemming start met status <b>active</b>. Alleen moderator kan <b>sluiten</b> en <b>vrijgeven</b>.</div>
                    </div>
                    <div class="col card">
                        <h2>Stemmingen</h2>
                        <div class="table-wrapper">
                            <table id="tbl-votes" class="tight">
                                <thead>
                                <tr>
                                    <th>Titel</th>
                                    <th>Wedstrijd</th>
                                    <th>Status</th>
                                    <th>Inzendingen</th>
                                    <th>Acties</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="reveal-panel" class="reveal-box hidden">
                            <h3>Individuele stemmen tonen</h3>
                            <div id="reveal-info" class="muted"></div>
                            <div id="reveal-list" class="list" style="max-height:220px;overflow:auto;"></div>
                            <div class="sticky-actions">
                                <button class="btn" id="btn-reveal-next">Volgende stem tonen</button>
                                <button class="btn warn" id="btn-reveal-start">Start reveal</button>
                                <button class="btn primary" id="btn-release" title="Moderator-only">Vrijgeven</button>
                            </div>
                            <div class="help">In de <b>revealing</b>-fase kunnen zowel <b>moderator</b> als <b>stemmen_lezer</b> Ã©Ã©n-voor-Ã©Ã©n stemmen openen. Pas als alle stemmen getoond zijn, kan de moderator vrijgeven.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
    const SUPABASE_URL = "https://hwqocccuzvnmrbxhtsey.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cW9jY2N1enZubXJieGh0c2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjU4MjIsImV4cCI6MjA3MjY0MTgyMn0.yZHHLfFVU_3S4Rnoxzo6srWv5Dfu8WsvL93ijMA-HmU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
<script>
    // ======================================================================
    //  DATA & PERSISTENTIE
    // ======================================================================
    const LS_KEY='peize3_data_v2';
    const nowIso = () => new Date().toISOString();
    const byId = id => document.getElementById(id);
    const qs = (sel,root=document)=>root.querySelector(sel);
    const qsa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));



    function addDaysISO(d){
      const dt=new Date(); dt.setDate(dt.getDate()+d);
      dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); // local to ISO input
      return dt.toISOString().slice(0,16);
    }

    let currentUser = null;
    let editingPlayerId = null;
    let editingMatchId = null;
    let activeRevealVoteId = null;

    // ASYNC FUNCTION SUPABASE
    // alle gebruikers laden
    async function loadUsers(){
      const { data, error } = await supabase.from('users').select('*').order('username');
      if(error){ console.error("loadUsers error", error); return []; }
      usersCache=data;
      return data;
    }
    // gebruiker opslaan
    async function saveUser(user){
      const { data, error } = await supabase.from('users').insert(user).select();
      if(error) console.error("saveUser error", error);
      return data;
    }
    // gebruiker updaten
    async function updateUser(id, fields){
      const { data, error } = await supabase.from('users').update(fields).eq('id',id).select();
      if(error) console.error("updateUser error", error);
      return data;
    }
    // gebruiker verwijderen
    async function deleteUser(id){
      const { error } = await supabase.from('users').delete().eq('id',id);
      if(error) console.error("deleteUser error", error);
    }
    async function loadPlayers(){
      const { data, error } = await supabase.from('players').select('*').order('name');
      if(error){ console.error("loadPlayers error", error); return []; }
      playersCache = data;
      return data;
    }

    async function savePlayer(player){
      const { data, error } = await supabase.from('players').insert(player).select();
      if(error) console.error("savePlayer error", error);
      return data;
    }

    async function updatePlayer(id, fields){
      const { data, error } = await supabase.from('players').update(fields).eq('id',id).select();
      if(error) console.error("updatePlayer error", error);
      return data;
    }

    async function deletePlayer(id){
      const { error } = await supabase.from('players').delete().eq('id',id);
      if(error) console.error("deletePlayer error", error);
    }
    async function loadMatches(){
      const { data, error } = await supabase.from('matches').select('*').order('date');
      if(error){ console.error("loadMatches error", error); return []; }
      matchesCache = data;
      return data;
    }

    async function saveMatch(match){
      const { data, error } = await supabase.from('matches').insert(match).select();
      if(error) console.error("saveMatch error", error);
      return data;
    }

    async function updateMatch(id, fields){
      const { data, error } = await supabase.from('matches').update(fields).eq('id',id).select();
      if(error) console.error("updateMatch error", error);
      return data;
    }

    async function deleteMatch(id){
      const { error } = await supabase.from('matches').delete().eq('id',id);
      if(error) console.error("deleteMatch error", error);
    }
    async function loadVotes(){
      const { data, error } = await supabase.from('votes').select('*').order('created_at');
      if(error){ console.error("loadVotes error", error); return []; }
      votesCaches=data;
      return data;
    }
    async function saveVote(vote){
      const { data, error } = await supabase.from('votes').insert(vote).select();
      if(error) console.error("saveVote error", error);
      return data;
    }
    async function updateVote(id, fields){
      const { data, error } = await supabase.from('votes').update(fields).eq('id',id).select();
      if(error) console.error("updateVote error", error);
      return data;
    }
    async function deleteVote(id){
      const { error } = await supabase.from('votes').delete().eq('id',id);
      if(error) console.error("deleteVote error", error);
    }
    async function loadUserVotes(voteId){
      const { data, error } = await supabase.from('user_votes').select('*').eq('vote_id', voteId);
      if(error){ console.error("loadUserVotes error", error); return []; }
      return data;
    }

    async function saveUserVote(vote){
      const { data, error } = await supabase.from('user_votes').insert(vote).select();
      if(error) console.error("saveUserVote error", error);
      return data;
    }

    async function deleteUserVote(id){
      const { error } = await supabase.from('user_votes').delete().eq('id',id);
      if(error) console.error("deleteUserVote error", error);
    }




    // ======================================================================
    //  HELPers
    // ======================================================================
    let playersCache = [];
    let matchesCache = [];
    let votesCache = [];
    let usersCache = [];
    function fmtDate(d){ if(!d) return ''; const t=new Date(d); return t.toLocaleString(); }
    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
    function ensureInt(v){ const n=parseInt(v,10); return isNaN(n)?null:n; }
    function matchResultText(m){ if(m.gfor==null || m.gagn==null) return 'â€”'; return m.gfor+' - '+m.gagn; }
    function isUpcoming(m){ return (new Date(m.date) > new Date()) && (m.gfor==null || m.gagn==null); }
    function isPlayed(m){ return Array.isArray(m.present) && m.present.length>0; } // >>> STATISTIEKEN OPSCHOON
    function playerById(id){ return playersCache.find(p=>p.id===id); }
    function matchById(id){ return matchesCache.find(m=>m.id===id); }
    function voteById(id){ return votesCache.find(v=>v.id===id); }
    function userById(id){ return usersCache.find(u=>u.id===id); }
    function userHasRole(role){ return currentUser && currentUser.role===role; }
    function canSeeAdmin(){ return currentUser && (currentUser.role==='moderator' || currentUser.role==='stemmen_lezer'); } // stemmen_lezer mag reveal-paneel zien
    function uniq(arr){ return Array.from(new Set(arr)); }

    // ======================================================================
    //  AUTH & NAV
    // ======================================================================
    async function hashPassword(password){
      const enc = new TextEncoder().encode(password);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf))
                  .map(b => b.toString(16).padStart(2, '0'))
                  .join('');
    }

    async function verifyPassword(password, hash){
      const encoder = new TextEncoder();
      const data = encoder.encode(password);

      // zelfde algoritme als bij hashPassword
      const digest = await crypto.subtle.digest('SHA-256', data);
      const hex = Array.from(new Uint8Array(digest))
                       .map(b => b.toString(16).padStart(2,'0'))
                       .join('');

      return hex === hash;
    }

    function updateNav(){
      byId('nav-auth').classList.toggle('hidden', !!currentUser);
      byId('nav-user').classList.toggle('hidden', !currentUser);
      byId('nav-admin').classList.toggle('hidden', !canSeeAdmin());
      byId('chip-user').textContent = currentUser ? `${currentUser.username} (${currentUser.role})` : 'â€¢';
    }
    function show(sec){
      qsa('.section').forEach(s=>s.classList.remove('active'));
      byId(sec).classList.add('active');
    }
    qsa('nav .btn[data-go]').forEach(b=>b.addEventListener('click', e=>{
      const sec=e.target.getAttribute('data-go');
      show(sec);
      if(sec==='matches') renderMatches();
      if(sec==='stats') renderStats();
      if(sec==='voting') renderVoting();
      if(sec==='admin') renderAdmin();
      if(sec==='klassement') renderKlassement();
    }));
    byId('btn-logout').addEventListener('click',()=>{ currentUser=null; updateNav(); show('home'); });

    byId('btn-login').addEventListener('click', async ()=>{
      const u = byId('login-user').value.trim();
      const p = byId('login-pass').value;

      if(!u || !p){
        alert('Gebruikersnaam en wachtwoord verplicht');
        return;
      }

      // user ophalen
      const { data: user, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', u)
        .maybeSingle();

      if(error){
        console.error("login error", error);
        alert("Er ging iets mis bij het inloggen.");
        return;
      }
      if(!user){
        alert('Onjuiste inlog');
        return;
      }

      // wachtwoord verifiÃ«ren (p vs. user.password_hash)
      const ok = await verifyPassword(p, user.password_hash);
      if(!ok){
        alert('Onjuiste inlog');
        return;
      }

      // login succesvol
      currentUser = user;
      updateNav();
      show('home');
      renderAll();
    });


    // ======================================================================
    //  HOME KPIs
    // ======================================================================
    async function renderKPIs(){
      // matches en spelers laden
      const matches = await loadMatches();
      const players = await loadPlayers();
      const userVotes = await supabase.from('user_votes').select('*');
      const uvData = userVotes.error ? [] : userVotes.data;

      // cache voor playerById
      const playersCache = players;
      function playerById(id){
        return playersCache.find(p => p.id === id);
      }

      // Winst, gelijk, verlies tellen
      let wins=0, draws=0, losses=0;
      matches.forEach(m=>{
        if(m.gfor!=null && m.gagn!=null){
          if(m.gfor > m.gagn) wins++;
          else if(m.gfor === m.gagn) draws++;
          else losses++;
        }
      });
      const points = wins*3 + draws;

      byId('home-wins').textContent   = wins;
      byId('home-draws').textContent  = draws;
      byId('home-losses').textContent = losses;
      byId('home-points').textContent = points;

      // Doelpunten & assists tellen
      const goals={}, assists={};
      players.forEach(p=>{ goals[p.id]=0; assists[p.id]=0; });
      matches.forEach(m=>{
        (m.goals||[]).forEach(g=>{
          if(g.scorer) goals[g.scorer]++;
          if(g.assist) assists[g.assist]++;
        });
      });

      // Top 3 doelpuntenmakers
      const topScorers = Object.entries(goals)
        .sort((a,b)=>b[1]-a[1]).slice(0,3);
      byId('kpi-scorers').innerHTML = topScorers.map(([pid,c])=>{
        const name = escapeHtml(playerById(+pid)?.name||'Onbekend');
        return `<li>${name}: ${c}</li>`;
      }).join('');

      // Top 3 assistgevers
      const topAssists = Object.entries(assists)
        .sort((a,b)=>b[1]-a[1]).slice(0,3);
      byId('kpi-assists').innerHTML = topAssists.map(([pid,c])=>{
        const name = escapeHtml(playerById(+pid)?.name||'Onbekend');
        return `<li>${name}: ${c}</li>`;
      }).join('');

      // King, Kut en Bonanza stemmen tellen
      const king={}, kut={}, bonanza={};
      players.forEach(p=>{ king[p.id]=0; kut[p.id]=0; bonanza[p.id]=0; });
      uvData.forEach(uv=>{
        if(uv.king) king[uv.king]++;
        if(uv.kut) kut[uv.kut]++;
        if(uv.bonanza) bonanza[uv.bonanza]++;
      });

      // Top 3 King
      const topKing = Object.entries(king)
        .sort((a,b)=>b[1]-a[1]).slice(0,3);
      byId('kpi-king').innerHTML = topKing.map(([pid,c])=>{
        const name = escapeHtml(playerById(+pid)?.name||'Onbekend');
        return `<li>${name}: ${c}</li>`;
      }).join('');

      // Top 3 Kut
      const topKut = Object.entries(kut)
        .sort((a,b)=>b[1]-a[1]).slice(0,3);
      byId('kpi-kut').innerHTML = topKut.map(([pid,c])=>{
        const name = escapeHtml(playerById(+pid)?.name||'Onbekend');
        return `<li>${name}: ${c}</li>`;
      }).join('');

      // Top 3 Bonanza
      const topBonanza = Object.entries(bonanza)
        .sort((a,b)=>b[1]-a[1]).slice(0,3);
      byId('kpi-bonanza').innerHTML = topBonanza.map(([pid,c])=>{
        const name = escapeHtml(playerById(+pid)?.name||'Onbekend');
        return `<li>${name}: ${c}</li>`;
      }).join('');
    }


    // ======================================================================
    //  MATCHES VIEW (Programma/Uitslagen)  -- Programma blijft bestaan
    // ======================================================================
    byId('tab-programma').addEventListener('click',()=>{ byId('programma-list').classList.remove('hidden'); byId('uitslagen-list').classList.add('hidden'); });
    byId('tab-uitslagen').addEventListener('click',()=>{ byId('programma-list').classList.add('hidden'); byId('uitslagen-list').classList.remove('hidden'); });

    async function renderMatches(){
      const pl = byId('programma-list');
      pl.innerHTML = '';
      const ul = byId('uitslagen-list');
      ul.innerHTML = '';

      // Matches en spelers ophalen
      const matches = await loadMatches();
      const players = await loadPlayers();

      // cache voor playerById
      function playerById(id){
        return players.find(p => p.id === id);
      }

      // splitsen in programma en uitslagen
      const upcoming = matches
        .filter(isUpcoming)
        .sort((a,b)=>new Date(a.date) - new Date(b.date));

      const results = matches
        .filter(m => m.gfor != null && m.gagn != null)
        .sort((a,b)=>new Date(b.date) - new Date(a.date));

      // Programma tonen
      upcoming.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row">
            <div class="col">
              <h3>${fmtDate(m.date)} â€¢ vs ${escapeHtml(m.opponent)}</h3>
              <div class="subtle">${m.location||''}</div>
              <div class="pill">Programma</div>
            </div>
            <div class="col" style="max-width:220px">
              <div>Uitslag: <b>${matchResultText(m)}</b></div>
            </div>
          </div>`;
        pl.appendChild(div);
      });

      // Uitslagen tonen
      results.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'card';
        const presentNames = (m.present||[])
          .map(pid => playerById(pid)?.name)
          .filter(Boolean).join(', ') || 'â€”';

        // Doelpunten renderen
        let goalsHtml = '';
        if(m.goals && m.goals.length > 0){
          goalsHtml = '<ul class="help">';
          m.goals.forEach(g=>{
            const scorer = playerById(g.scorer)?.name || 'â€”';
            const assist = g.type==='veld' && g.assist
              ? (' (assist: '+(playerById(g.assist)?.name||'â€”')+')')
              : '';
            const type = g.type==='penalty' ? 'Penalty' : 'Veldgoal';
            goalsHtml += `<li>${type}: ${escapeHtml(scorer)}${assist}</li>`;
          });
          goalsHtml += '</ul>';
        }

        div.innerHTML = `
          <div class="row">
            <div class="col">
              <h3>${fmtDate(m.date)} â€¢ vs ${escapeHtml(m.opponent)}</h3>
              <div class="subtle">${m.location||''}</div>
              <div class="pill">Uitslag: <b>${matchResultText(m)}</b></div>
              <div class="help">Aanwezigen: ${presentNames}</div>
              ${goalsHtml}
            </div>
            <div class="col" style="max-width:220px">
              <div>${m.report?escapeHtml(m.report):''}</div>
            </div>
          </div>`;
        ul.appendChild(div);
      });
    }


    // ======================================================================
    //  STATS (gespeelde wedstrijden per speler)  -- kaarten verwijderd
    // ======================================================================
    async function renderKlassement(){
      const tb = byId('tbl-klassement').querySelector('tbody');
      tb.innerHTML = '';

      // spelers en stemmen ophalen
      const players = await loadPlayers();
      const { data: votesData, error } = await supabase.from('user_votes').select('*');
      if(error){ console.error("renderKlassement load user_votes", error); return; }

      // tellers
      const king = {}, kut = {}, bonanza = {};
      players.forEach(p=>{
        king[p.id]=0; kut[p.id]=0; bonanza[p.id]=0;
      });

      // doorloop alle userVotes
      votesData.forEach(uv=>{
        if(uv.king) king[uv.king]++;
        if(uv.kut) kut[uv.kut]++;
        if(uv.bonanza) bonanza[uv.bonanza]++;
      });

      // render tabel
      players.forEach(p=>{
        const k = king[p.id] || 0;
        const ku = kut[p.id] || 0;
        const b = bonanza[p.id] || 0;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.name)}</td>
          <td>${k}</td>
          <td>${ku}</td>
          <td>${b}</td>
        `;
        tb.appendChild(tr);
      });

      makeTableSortable('tbl-klassement');
    }


    async function renderStats(){
      const tb = byId('tbl-stats').querySelector('tbody');
      tb.innerHTML = '';

      // spelers en wedstrijden ophalen
      const players = await loadPlayers();
      const matches = await loadMatches();

      // Gespeelde wedstrijden tellen
      const counts = Object.fromEntries(players.map(p => [p.id, 0]));
      matches.forEach(m =>
        (m.present || []).forEach(pid => {
          counts[pid] = (counts[pid] || 0) + 1;
        })
      );

      // Doelpunten & Assists tellen
      const goalsFor = {}, assistsFor = {};
      players.forEach(p => { goalsFor[p.id] = 0; assistsFor[p.id] = 0; });
      matches.forEach(m=>{
        (m.goals || []).forEach(g=>{
          if(g.scorer) goalsFor[g.scorer]++;
          if(g.assist) assistsFor[g.assist]++;
        });
      });

      // Spelersrijen renderen
      players.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.position||'')}</td>
          <td>${counts[p.id]||0}</td>
          <td>${goalsFor[p.id]||0}</td>
          <td>${assistsFor[p.id]||0}</td>
        `;
        tb.appendChild(tr);
      });

      // Sorteerfunctie activeren
      makeTableSortable('tbl-stats');
    }

    function makeTableSortable(tableId){
      const table = byId(tableId);
      const headers = table.querySelectorAll('th');
      headers.forEach((th, idx)=>{
        th.addEventListener('click', ()=>{
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const asc = !th.classList.contains('asc');
          // reset andere kolommen
          table.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
          th.classList.add(asc?'asc':'desc');

          rows.sort((a,b)=>{
            let A = a.children[idx].textContent.trim();
            let B = b.children[idx].textContent.trim();
            const nA = parseFloat(A), nB = parseFloat(B);
            if(!isNaN(nA) && !isNaN(nB)){
              return asc ? nA-nB : nB-nA;
            }
            return asc ? A.localeCompare(B) : B.localeCompare(A);
          });
          rows.forEach(r=>tbody.appendChild(r));
        });
      });
    }


    // ======================================================================
    //  VOTING (user)
    //  - Resultaten geheim tot vrijgave
    //  - reveal flow hieronder in Admin -> Stemmingen
    // ======================================================================
    async function renderVoting(){
      const activeBox = byId('vote-active-list');
      activeBox.innerHTML = '';
      const relBox = byId('vote-released-list');
      relBox.innerHTML = '';

      const myId = currentUser?.id;

      // stemmen en wedstrijden ophalen
      const { data: votes, error: vErr } = await supabase.from('votes').select('*');
      if(vErr){ console.error("renderVoting load votes", vErr); return; }

      const matches = await loadMatches();
      const players = await loadPlayers();

      // helper om match bij id te zoeken
      function matchById(id){
        return matches.find(m => m.id === id);
      }

      // mijn stemmen ophalen
      let myVotes = [];
      if(myId){
        const { data: uvData, error: uvErr } = await supabase
          .from('user_votes')
          .select('*')
          .eq('user_id', myId);
        if(uvErr){ console.error("renderVoting load user_votes", uvErr); }
        else { myVotes = uvData; }
      }

      // actieve en vrijgegeven stemmen splitsen
      const activeVotes   = votes.filter(v => v.status==='active' || v.status==='closed' || v.status==='revealing');
      const releasedVotes = votes.filter(v => v.status==='released');

      // actieve stemmen renderen
      for(const v of activeVotes){
        const card = document.createElement('div');
        card.className = 'card';
        const m = matchById(v.matchId);
        const mySubmission = myVotes.find(u => u.vote_id === v.id);
        let statusIcon = v.status==='active'
          ? 'st-active'
          : (v.status==='closed' ? 'st-closed' : (v.status==='revealing' ? 'st-revealing' : 'st-released'));

        card.innerHTML = `
          <div class="row">
            <div class="col">
              <h3><span class="status-dot ${statusIcon}"></span>${escapeHtml(v.title)}</h3>
              <div class="subtle">Wedstrijd: ${m?escapeHtml(m.opponent):'â€”'} | Status: <b>${v.status}</b></div>
            </div>
          </div>
          <div class="divider"></div>
        `;

        const body = document.createElement('div');
        if(v.status==='active'){
          if(!currentUser){
            body.innerHTML = '<div class="help">Log in om te stemmen.</div>';
          } else if(mySubmission){
            body.innerHTML = '<div class="pill">Je hebt al gestemd. Resultaten blijven verborgen tot vrijgave.</div>';
          } else {
            body.appendChild(renderVoteForm(v));
          }
        } else {
          body.innerHTML = '<div class="help">Stemming is niet actief. Resultaten blijven verborgen tot vrijgave.</div>';
        }
        card.appendChild(body);
        activeBox.appendChild(card);
      }

      // vrijgegeven stemmen renderen
      for(const v of releasedVotes){
        const card = document.createElement('div');
        card.className = 'card';
        const m = matchById(v.matchId);

        // alle stemmen voor deze stemming ophalen
        const { data: uvAgg, error: uvAggErr } = await supabase
          .from('user_votes')
          .select('*')
          .eq('vote_id', v.id);
        if(uvAggErr){ console.error("renderVoting agg", uvAggErr); continue; }

        const agg = aggregateVote(players, uvAgg);
        card.innerHTML = `
          <h3><span class="status-dot st-released"></span>${escapeHtml(v.title)}</h3>
          <div class="subtle">Wedstrijd: ${m?escapeHtml(m.opponent):'â€”'} | Status: <b>${v.status}</b></div>
          <div class="divider"></div>
          ${renderAggHtml(agg)}
        `;
        relBox.appendChild(card);
      }
    }


    async function renderVoteForm(v){
      const box = document.createElement('div');
      box.className = 'vote-box';

      // spelers laden
      const players = await loadPlayers();
      const opts = players.map(p =>
        `<option value="${p.id}">${escapeHtml(p.name)}</option>`
      ).join('');

      // formulier HTML
      box.innerHTML = `
        <div class="vote-row"><label style="min-width:160px">King</label>
          <select class="vote-king"><option value="">â€”</option>${opts}</select>
        </div>
        <label>Opmerking bij King</label>
        <textarea class="vote-comment-king" rows="2" placeholder="optioneel"></textarea>

        <div class="vote-row"><label style="min-width:160px">Kut</label>
          <select class="vote-kut"><option value="">â€”</option>${opts}</select>
        </div>
        <label>Opmerking bij Kut</label>
        <textarea class="vote-comment-kut" rows="2" placeholder="optioneel"></textarea>

        <div class="vote-row"><label style="min-width:160px">Bonanza</label>
          <select class="vote-bonanza"><option value="">â€”</option>${opts}</select>
        </div>
        <label>Opmerking bij Bonanza</label>
        <textarea class="vote-comment-bonanza" rows="2" placeholder="optioneel"></textarea>

        <div class="sticky-actions"><button class="btn primary">Versturen</button></div>
      `;

      // event handler
      box.querySelector('button').addEventListener('click', async ()=>{
        if(!currentUser){
          alert('Log in om te stemmen.');
          return;
        }

        const king  = ensureInt(box.querySelector('.vote-king').value);
        const kut   = ensureInt(box.querySelector('.vote-kut').value);
        const bon   = ensureInt(box.querySelector('.vote-bonanza').value);
        const cKing = box.querySelector('.vote-comment-king').value.trim();
        const cKut  = box.querySelector('.vote-comment-kut').value.trim();
        const cBon  = box.querySelector('.vote-comment-bonanza').value.trim();

        const newVote = {
          vote_id: v.id,
          user_id: currentUser.id,
          king, kut, bonanza: bon,
          cking: cKing,
          ckut: cKut,
          cbon: cBon,
          created_at: nowIso()
        };

        const { error } = await supabase.from('user_votes').insert(newVote);
        if(error){
          console.error("Vote insert error", error);
          alert("Er ging iets mis bij het opslaan van je stem.");
          return;
        }

        // opnieuw renderen
        renderVoting();
        renderAdminVotes();
      });

      return box;
    }


    async function aggregateVote(voteId){
      const players = await loadPlayers();
      const { data: userVotes, error } = await supabase
        .from('user_votes')
        .select('*')
        .eq('vote_id', voteId);

      if(error){ console.error("aggregateVote error", error); return { king:{}, kut:{}, bonanza:{} }; }

      const king={}, kut={}, bonanza={};
      players.forEach(p=>{ king[p.id]=0; kut[p.id]=0; bonanza[p.id]=0; });
      userVotes.forEach(uv=>{
        if(uv.king) king[uv.king]++;
        if(uv.kut) kut[uv.kut]++;
        if(uv.bonanza) bonanza[uv.bonanza]++;
      });
      return { king, kut, bonanza };
    }

    function renderAggHtml(agg){
      const mk = (obj,title)=>{
        const arr = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
        if(arr.length===0) return `<div><b>${title}:</b> â€”</div>`;

        const max = arr[0][1]; // hoogste aantal stemmen

        return `<div><b>${title}:</b> ` + arr.map(([pid,c])=>{
          const name = escapeHtml(playerById(+pid)?.name || 'Onbekend');
          const isWinner = c === max;
          const highlight = isWinner ? ' style="font-weight:bold;color:#22c55e"' : '';
          return `<span${highlight}>${name} <span class="pill">${c}</span></span>`;
        }).join(', ') + `</div>`;
      };

      return mk(agg.king,'King')
           + mk(agg.kut,'Kut')
           + mk(agg.bonanza,'Bonanza');
    }


    // ======================================================================
    //  ADMIN
    // ======================================================================
    function renderAdmin(){
      // tab visible permissions
      qsa('.adtab').forEach(x=>x.classList.add('hidden'));
      byId('ad-users').classList.toggle('hidden', !userHasRole('moderator'));
      byId('ad-players').classList.toggle('hidden', !userHasRole('moderator'));
      byId('ad-matches').classList.toggle('hidden', !userHasRole('moderator'));
      // Stemmingen-tab zichtbaar voor moderator en stemmen_lezer
      byId('ad-votes').classList.toggle('hidden', !canSeeAdmin());

      // default open the first visible tab
      const visibleTabs = [
        {key:'users',el:'ad-users',btnSel:"[data-adtab='users']"},
        {key:'players',el:'ad-players',btnSel:"[data-adtab='players']"},
        {key:'matches',el:'ad-matches',btnSel:"[data-adtab='matches']"},
        {key:'votes',el:'ad-votes',btnSel:"[data-adtab='votes']"}
      ].filter(x=>!byId(x.el).classList.contains('hidden'));
      qsa('.adtab').forEach(x=>x.classList.add('hidden'));
      if(visibleTabs.length>0){ byId(visibleTabs[0].el).classList.remove('hidden'); }

      // tab buttons
      qsa('[data-adtab]').forEach(btn=>{
        btn.onclick=()=>{
          qsa('.adtab').forEach(x=>x.classList.add('hidden'));
          const target=btn.getAttribute('data-adtab');
          byId('ad-'+target).classList.remove('hidden');
        };
      });

      renderAdminUsers();
      renderAdminPlayers();
      renderAdminMatches();
      renderAdminVotes();
    }

    // --- USERS
    byId('btn-add-user').addEventListener('click', async ()=>{
      const name = byId('new-usr-name').value.trim();
      const pass = byId('new-usr-pass').value;
      const role = byId('new-usr-role').value;

      if(!name || !pass){
        alert('Naam en wachtwoord verplicht');
        return;
      }

      // check of de usernaam al bestaat
      const { data: existing, error: checkErr } = await supabase
        .from('users')
        .select('id')
        .eq('username', name)
        .maybeSingle();

      if(checkErr){
        console.error("check user error", checkErr);
        alert("Er ging iets mis bij het controleren van de gebruikersnaam.");
        return;
      }

      if(existing){
        alert('Gebruikersnaam bestaat al');
        return;
      }

      // wachtwoord hashen
      const hashed = await hashPassword(pass);

      // nieuwe user opslaan
      const { error: insErr } = await supabase.from('users').insert({
        username: name,
        password_hash: hashed,
        role: role
      });

      if(insErr){
        console.error("insert user error", insErr);
        alert("Er ging iets mis bij het toevoegen van de gebruiker.");
        return;
      }

      // UI verversen
      await renderAdminUsers();

      // formulier resetten
      byId('new-usr-name').value = '';
      byId('new-usr-pass').value = '';
      byId('new-usr-role').value = 'user';
    });
    async function renderAdminUsers(){
      const tb = byId('tbl-users').querySelector('tbody');
      tb.innerHTML = '';

      const users = await loadUsers(); // uit Supabase

      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(u.username)}</td>
          <td>
            ${currentUser?.role==='moderator'
              ? `<select data-uid="${u.id}" class="role-sel">
                   <option value="user"${u.role==='user'?' selected':''}>user</option>
                   <option value="stemmen_lezer"${u.role==='stemmen_lezer'?' selected':''}>stemmen_lezer</option>
                   <option value="moderator"${u.role==='moderator'?' selected':''}>moderator</option>
                 </select>`
              : `<span class="pill">${u.role}</span>`}
          </td>
          <td>${currentUser?.role==='moderator'
            ? `<button class="btn" data-act="reset" data-id="${u.id}">Wachtw. reset</button>`
            : ''}</td>
        `;
        tb.appendChild(tr);
      });

      // rol wijzigen
      qsa('.role-sel',tb).forEach(sel =>
        sel.addEventListener('change', async e=>{
          const id = +e.target.getAttribute('data-uid');
          const newRole = e.target.value;

          const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', id);

          if(error){
            console.error("update role error", error);
            alert("Kon rol niet aanpassen");
          } else {
            updateNav();
            renderAdmin();
          }
        })
      );

      // wachtwoord reset
      qsa('button[data-act="reset"]',tb).forEach(btn=>
        btn.addEventListener('click', async ()=>{
          const id = +btn.getAttribute('data-id');
          const u = users.find(x => x.id === id);
          if(!u) return;

          const np = prompt('Nieuw wachtwoord voor '+u.username, 'changeme');
          if(np){
            const hashed = await hashPassword(np);
            const { error } = await supabase
              .from('users')
              .update({ password_hash: hashed })
              .eq('id', id);

            if(error){
              console.error("reset password error", error);
              alert("Kon wachtwoord niet aanpassen");
            } else {
              alert('Wachtwoord aangepast');
            }
          }
        })
      );
    }


    // --- PLAYERS
    // speler opslaan
    byId('btn-save-player').addEventListener('click', async ()=>{
      const name = byId('pl-name').value.trim();
      const pos  = byId('pl-pos').value.trim();
      if(!name) return alert('Naam verplicht');

      if(editingPlayerId){
        // speler bewerken
        const { error } = await supabase
          .from('players')
          .update({ name, position: pos })
          .eq('id', editingPlayerId);

        if(error){
          console.error("update player error", error);
          alert("Kon speler niet opslaan.");
          return;
        }
        editingPlayerId = null;
      } else {
        // nieuwe speler toevoegen
        const { error } = await supabase
          .from('players')
          .insert({ name, position: pos });

        if(error){
          console.error("insert player error", error);
          alert("Kon speler niet toevoegen.");
          return;
        }
      }

      // formulier reset
      byId('pl-name').value = '';
      byId('pl-pos').value = '';

      // UI verversen
      renderAdminPlayers();
      renderMatches();
      renderStats();
      renderVoting();
      renderKlassement();
    });

    // annuleren
    byId('btn-cancel-player').addEventListener('click', ()=>{
      editingPlayerId = null;
      byId('pl-name').value = '';
      byId('pl-pos').value = '';
    });

    // spelerslijst renderen
    async function renderAdminPlayers(){
      // presence checkboxes template
      renderPresenceCheckboxes();

      const tb = byId('tbl-players').querySelector('tbody');
      tb.innerHTML = '';

      const players = await loadPlayers();

      players.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.position||'')}</td>
          <td>
            <button class="btn" data-ed="${p.id}">Bewerken</button>
            <button class="btn danger" data-del="${p.id}">Verwijderen</button>
          </td>`;
        tb.appendChild(tr);
      });

      // speler bewerken
      qsa('button[data-ed]',tb).forEach(b =>
        b.addEventListener('click', ()=>{
          const id = +b.getAttribute('data-ed');
          const p = players.find(pl => pl.id === id);
          if(!p) return;
          editingPlayerId = id;
          byId('pl-name').value = p.name;
          byId('pl-pos').value = p.position || '';
        })
      );

      // speler verwijderen
      qsa('button[data-del]',tb).forEach(b =>
        b.addEventListener('click', async ()=>{
          const id = +b.getAttribute('data-del');
          if(!confirm('Deze speler verwijderen?')) return;

          // speler verwijderen
          const { error: delErr } = await supabase
            .from('players')
            .delete()
            .eq('id', id);

          if(delErr){
            console.error("delete player error", delErr);
            alert("Kon speler niet verwijderen.");
            return;
          }

          // speler ook verwijderen uit matches.present
          const matches = await loadMatches();
          for(const m of matches){
            if(m.present && m.present.includes(id)){
              const newPresent = m.present.filter(pid => pid !== id);
              await supabase
                .from('matches')
                .update({ present: newPresent })
                .eq('id', m.id);
            }
          }

          // UI verversen
          renderAdminPlayers();
          renderMatches();
          renderStats();
          renderVoting();
          renderKlassement();
        })
      );
    }

    // --- MATCHES
    let currentGoals = [];

    // Doelpuntenformulier
    async function renderGoalsForm(goals = []){
      const box = byId('goals-box');
      box.innerHTML = '';

      const players = await loadPlayers();

      goals.forEach((g, idx) => {
        const opts = players.map(p =>
          `<option value="${p.id}" ${p.id===g.scorer?'selected':''}>${escapeHtml(p.name)}</option>`
        ).join('');
        const optsAssist = players.map(p =>
          `<option value="${p.id}" ${p.id===g.assist?'selected':''}>${escapeHtml(p.name)}</option>`
        ).join('');

        box.innerHTML += `
          <div class="card">
            <label>Type</label>
            <select class="goal-type" data-idx="${idx}">
              <option value="veld" ${g.type==='veld'?'selected':''}>Veldgoal</option>
              <option value="penalty" ${g.type==='penalty'?'selected':''}>Penalty</option>
            </select>
            <label>Doelpuntenmaker</label>
            <select class="goal-scorer" data-idx="${idx}">${opts}</select>
            <div class="assist-box" ${g.type==='penalty'?'style="display:none"':''}>
              <label>Assist</label>
              <select class="goal-assist" data-idx="${idx}">
                <option value="">â€”</option>${optsAssist}
              </select>
            </div>
            <button class="btn danger" onclick="removeGoal(${idx})">âŒ Verwijderen</button>
          </div>
        `;
      });
    }

    // Aanwezigheden formulier
    async function renderPresenceCheckboxes(selected = []){
      const box = byId('presence-box');
      box.innerHTML = '';

      const players = await loadPlayers();

      players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.innerHTML = `
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" value="${p.id}" ${selected.includes(p.id) ? 'checked' : ''}/>
            <span>${escapeHtml(p.name)}</span>
          </label>`;
        box.appendChild(div);
      });
    }
    function removeGoal(idx){
      currentGoals.splice(idx,1);
      renderGoalsForm(currentGoals);
    }
    byId('btn-add-goal').addEventListener('click',()=>{
      currentGoals.push({type:'veld', scorer:null, assist:null});
      renderGoalsForm(currentGoals);
    });
    byId('btn-save-match').addEventListener('click', async ()=>{
      const op  = byId('mt-opponent').value.trim();
      const dt  = byId('mt-date').value;
      const loc = byId('mt-location').value.trim();
      const gfor = byId('mt-gfor').value==='' ? null : ensureInt(byId('mt-gfor').value);
      const gagn = byId('mt-gagn').value==='' ? null : ensureInt(byId('mt-gagn').value);
      const rep  = byId('mt-report').value.trim();
      const present = qsa('#presence-box input[type="checkbox"]:checked').map(cb=>+cb.value);
      const goals   = collectGoalsForm();

      if(!op || !dt){
        alert('Tegenstander en datum zijn verplicht');
        return;
      }

      if(editingMatchId){
        // bestaande wedstrijd updaten
        const { error } = await supabase
          .from('matches')
          .update({
            opponent: op,
            date: dt,
            location: loc,
            gfor,
            gagn,
            report: rep,
            present,
            goals
          })
          .eq('id', editingMatchId);

        if(error){
          console.error("update match error", error);
          alert("Kon wedstrijd niet opslaan.");
          return;
        }

        editingMatchId = null;
      } else {
        // nieuwe wedstrijd toevoegen
        const { error } = await supabase
          .from('matches')
          .insert({
            opponent: op,
            date: dt,
            location: loc,
            gfor,
            gagn,
            report: rep,
            present,
            goals
          });

        if(error){
          console.error("insert match error", error);
          alert("Kon wedstrijd niet toevoegen.");
          return;
        }
      }

      // reset formulier
      byId('edit-match-id').value = '';
      byId('mt-opponent').value   = '';
      byId('mt-date').value       = '';
      byId('mt-location').value   = '';
      byId('mt-gfor').value       = '';
      byId('mt-gagn').value       = '';
      byId('mt-report').value     = '';
      renderPresenceCheckboxes([]);

      // UI verversen
      renderAdminMatches();
      renderMatches();
      renderStats();
    });

    byId('btn-cancel-match').addEventListener('click',()=>{
      editingMatchId=null;
      byId('edit-match-id').value=''; byId('mt-opponent').value=''; byId('mt-date').value=''; byId('mt-location').value='';
      byId('mt-gfor').value=''; byId('mt-gagn').value=''; byId('mt-report').value=''; renderPresenceCheckboxes([]);
    });
    function collectGoalsForm(){
      return qsa('#goals-box .card').map((div, idx)=>{
        const type = div.querySelector('.goal-type').value;
        const scorer = ensureInt(div.querySelector('.goal-scorer').value);
        const assistEl = div.querySelector('.goal-assist');
        const assist = assistEl ? ensureInt(assistEl.value) : null;
        return {type, scorer, assist};
      });
    }
    async function renderAdminMatches(){
      // wedstrijden ophalen
      const matches = await loadMatches();

      // fill match options for votes tab
      const sel = byId('vt-match');
      sel.innerHTML = matches
        .map(m => `<option value="${m.id}">${fmtDate(m.date)} vs ${escapeHtml(m.opponent)}</option>`)
        .join('');

      // lijst vullen
      const tb = byId('tbl-matches').querySelector('tbody');
      tb.innerHTML = '';
      matches
        .sort((a,b)=>new Date(b.date) - new Date(a.date))
        .forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap">${fmtDate(m.date)}</td>
            <td>${escapeHtml(m.opponent)}</td>
            <td>${matchResultText(m)}</td>
            <td>
              <button class="btn" data-ed="${m.id}">Bewerken</button>
              <button class="btn danger" data-del="${m.id}">Verwijderen</button>
            </td>`;
          tb.appendChild(tr);
        });

      // bewerken
      qsa('button[data-ed]',tb).forEach(b =>
        b.addEventListener('click', ()=>{
          const id = +b.getAttribute('data-ed');
          const m = matches.find(x => x.id === id);
          if(!m) return;

          editingMatchId = id;
          byId('edit-match-id').value = id;
          byId('mt-opponent').value   = m.opponent;
          byId('mt-date').value       = m.date ? m.date.slice(0,16) : '';
          byId('mt-location').value   = m.location || '';
          byId('mt-gfor').value       = m.gfor ?? '';
          byId('mt-gagn').value       = m.gagn ?? '';
          byId('mt-report').value     = m.report || '';
          renderPresenceCheckboxes(m.present || []);
          currentGoals = m.goals || [];
          renderGoalsForm(currentGoals);

          // scroll naar formulier
          byId('ad-matches').scrollIntoView({behavior:'smooth',block:'start'});
        })
      );

      // verwijderen
      qsa('button[data-del]',tb).forEach(b =>
        b.addEventListener('click', async ()=>{
          const id = +b.getAttribute('data-del');
          if(!confirm('Wedstrijd verwijderen?')) return;

          // wedstrijd verwijderen
          const { error: delErr } = await supabase
            .from('matches')
            .delete()
            .eq('id', id);
          if(delErr){
            console.error("delete match error", delErr);
            alert("Kon wedstrijd niet verwijderen.");
            return;
          }

          // gekoppelde stemmingen loskoppelen
          const { error: updErr } = await supabase
            .from('votes')
            .update({ matchId: null })
            .eq('matchId', id);
          if(updErr){
            console.error("unlink votes error", updErr);
          }

          // UI verversen
          renderAdminMatches();
          renderMatches();
          renderStats();
          renderVoting();
        })
      );
    }



    // --- VOTES (Admin/Lezer)
    byId('btn-add-vote').addEventListener('click', async ()=>{
      if(!userHasRole('moderator')){
        alert('Alleen moderator');
        return;
      }

      const title = byId('vt-title').value.trim();
      const matchId = ensureInt(byId('vt-match').value);

      if(!title || !matchId){
        alert('Titel en wedstrijd zijn verplicht');
        return;
      }

      const newVote = {
        title,
        matchId,
        status: 'active',
        createdAt: nowIso(),
        createdBy: currentUser.id,
        revealedCount: 0
      };

      const { error } = await supabase.from('votes').insert(newVote);
      if(error){
        console.error("insert vote error", error);
        alert("Kon stemming niet toevoegen.");
        return;
      }

      byId('vt-title').value = '';

      // UI verversen
      renderAdminVotes();
      renderVoting();
    });


    async function renderAdminVotes(){
      const tb = byId('tbl-votes').querySelector('tbody');
      tb.innerHTML = '';

      // alle stemmingen ophalen
      const { data: votes, error: vErr } = await supabase
        .from('votes')
        .select('*')
        .order('id', { ascending: false });
      if(vErr){ console.error("load votes error", vErr); return; }

      // alle stemmen per stemming ophalen
      const { data: userVotes, error: uvErr } = await supabase
        .from('user_votes')
        .select('vote_id');
      if(uvErr){ console.error("load user_votes error", uvErr); return; }

      // wedstrijden voor koppeling
      const matches = await loadMatches();

      votes.forEach(v=>{
        const tr = document.createElement('tr');
        const m = matches.find(mm => mm.id === v.matchId);
        const cnt = userVotes.filter(u => u.vote_id === v.id).length;
        const statusIcon =
          v.status==='active'    ? 'st-active' :
          v.status==='closed'    ? 'st-closed' :
          v.status==='revealing' ? 'st-revealing' :
                                   'st-released';

        tr.innerHTML = `
          <td>${escapeHtml(v.title)}</td>
          <td>${m?escapeHtml(m.opponent):'â€”'}</td>
          <td><span class="status-dot ${statusIcon}"></span>${v.status}</td>
          <td>${cnt}</td>
          <td class="nowrap">
            ${userHasRole('moderator') && v.status==='active'
              ? `<button class="btn warn" data-act="close" data-id="${v.id}">Sluiten</button>`
              : ''}
            ${(canSeeAdmin() && (v.status==='closed' || v.status==='revealing'))
              ? `<button class="btn" data-act="open-reveal" data-id="${v.id}">Reveal</button>`
              : ''}
            ${userHasRole('moderator') && v.status!=='released'
              ? `<button class="btn primary" data-act="release" data-id="${v.id}">Vrijgeven</button>`
              : ''}
          </td>
        `;
        tb.appendChild(tr);
      });

      // acties

      // sluiten
      qsa('button[data-act="close"]',tb).forEach(btn =>
        btn.addEventListener('click', async ()=>{
          const id = +btn.getAttribute('data-id');
          if(!confirm('Stemming sluiten? Gebruikers kunnen daarna niet meer stemmen.')) return;

          const { error } = await supabase
            .from('votes')
            .update({ status: 'closed' })
            .eq('id', id);

          if(error){
            console.error("close vote error", error);
            alert("Kon stemming niet sluiten");
            return;
          }

          renderAdminVotes();
          renderVoting();
        })
      );

      // reveal starten (paneel openen)
      qsa('button[data-act="open-reveal"]',tb).forEach(btn =>
        btn.addEventListener('click', ()=>{
          const id = +btn.getAttribute('data-id');
          openRevealPanel(id);
        })
      );

      // vrijgeven
      qsa('button[data-act="release"]',tb).forEach(btn =>
        btn.addEventListener('click', async ()=>{
          const id = +btn.getAttribute('data-id');

          if(!userHasRole('moderator')){
            alert('Alleen moderator kan vrijgeven');
            return;
          }

          // aantal stemmen ophalen
          const { data: uvTotal, error: uvCountErr } = await supabase
            .from('user_votes')
            .select('id', { count: 'exact' })
            .eq('vote_id', id);
          if(uvCountErr){ console.error("count votes error", uvCountErr); return; }

          const total = uvTotal?.length || 0;

          // stemming ophalen om revealedCount te checken
          const v = votes.find(x => x.id === id);
          if(total > 0 && v.revealedCount < total){
            alert('Nog niet alle individuele stemmen getoond. Maak eerst de reveal af.');
            return;
          }

          if(!confirm('Resultaten definitief vrijgeven? Daarna zijn ze altijd zichtbaar.')) return;

          const { error } = await supabase
            .from('votes')
            .update({ status: 'released' })
            .eq('id', id);

          if(error){
            console.error("release vote error", error);
            alert("Kon stemming niet vrijgeven");
            return;
          }

          renderAdminVotes();
          renderVoting();
          closeRevealPanel();
        })
      );
    }


    async function openRevealPanel(voteId){
      // stemming ophalen
      const { data: vote, error: vErr } = await supabase
        .from('votes')
        .select('*')
        .eq('id', voteId)
        .single();
      if(vErr){ console.error("load vote error", vErr); return; }
      if(!vote) return;

      activeRevealVoteId = voteId;

      const panel = byId('reveal-panel');
      panel.classList.remove('hidden');

      const info = byId('reveal-info');
      const list = byId('reveal-list');
      list.innerHTML = '';

      // stemmen ophalen (chronologisch)
      const { data: userVotes, error: uvErr } = await supabase
        .from('user_votes')
        .select('*')
        .eq('vote_id', voteId)
        .order('created_at', { ascending: true });
      if(uvErr){ console.error("load user_votes error", uvErr); return; }

      const total = userVotes.length;

      if(vote.status==='closed'){
        info.textContent = 'Status: closed. Start de reveal om stemmen Ã©Ã©n-voor-Ã©Ã©n te tonen.';
      }
      if(vote.status==='revealing'){
        info.textContent = `Status: revealing. Getoond: ${vote.revealedCount}/${total}`;
      }
      if(vote.status==='released'){
        info.textContent = 'Status: released. Alles is al vrijgegeven.';
      }

      byId('btn-reveal-start').classList.toggle('hidden', vote.status!=='closed');
      byId('btn-reveal-next').classList.toggle('hidden', vote.status!=='revealing');
      byId('btn-release').disabled = !(userHasRole('moderator'));

      // reeds getoonde items weergeven (eerste revealedCount stemmen in chronologische volgorde)
      userVotes.slice(0, vote.revealedCount).forEach((uv, idx)=>{
        const item = document.createElement('div');
        item.className = 'card';
        item.innerHTML = renderUserVoteItem(uv, idx+1);
        list.appendChild(item);
      });
    }


    byId('btn-reveal-start').addEventListener('click',()=>{
      if(activeRevealVoteId==null) return;
      const v=voteById(activeRevealVoteId); if(!v) return;
      // >>> STEMMING REVEAL FLOW: zowel moderator als stemmen_lezer mogen starten na 'closed'
      if(!(userHasRole('moderator') || userHasRole('stemmen_lezer'))) return alert('Geen rechten');
      if(v.status!=='closed') return alert('Reveal kan alleen vanuit status closed');
      v.status='revealing'; v.revealedCount=0; save(); openRevealPanel(activeRevealVoteId); renderAdminVotes();
    });
    byId('btn-reveal-next').addEventListener('click', async ()=>{
      if(activeRevealVoteId == null) return;

      // stemming ophalen
      const { data: v, error: vErr } = await supabase
        .from('votes')
        .select('*')
        .eq('id', activeRevealVoteId)
        .single();
      if(vErr){ console.error("load vote error", vErr); return; }
      if(!v) return;

      // rechten controleren
      if(!(userHasRole('moderator') || userHasRole('stemmen_lezer'))){
        alert('Geen rechten');
        return;
      }
      if(v.status !== 'revealing'){
        alert('Niet in reveal-status');
        return;
      }

      // stemmen ophalen (chronologisch)
      const { data: rows, error: uvErr } = await supabase
        .from('user_votes')
        .select('*')
        .eq('vote_id', activeRevealVoteId)
        .order('created_at', { ascending: true });
      if(uvErr){ console.error("load user_votes error", uvErr); return; }

      if(v.revealedCount >= rows.length){
        alert('Alle stemmen zijn al getoond. Moderator kan nu vrijgeven.');
        return;
      }

      // volgende stem pakken
      const uv = rows[v.revealedCount];

      // revealedCount verhogen in db
      const { error: updErr } = await supabase
        .from('votes')
        .update({ revealedCount: v.revealedCount + 1 })
        .eq('id', v.id);
      if(updErr){ console.error("update revealedCount error", updErr); return; }

      // toevoegen aan lijst
      const list = byId('reveal-list');
      const item = document.createElement('div');
      item.className = 'card';
      item.innerHTML = renderUserVoteItem(uv, v.revealedCount + 1);
      list.appendChild(item);

      // statusinfo bijwerken
      byId('reveal-info').textContent =
        `Status: revealing. Getoond: ${v.revealedCount + 1}/${rows.length}`;
    });


    function renderUserVoteItem(uv, idx){
      const user = userById(uv.userId);
      const p = id=> escapeHtml(playerById(id)?.name || 'â€”');
      return `<div><b>Stem ${idx}</b></div>
        <div>King: ${p(uv.king)}</div
        ${uv.cKing? `<div class="help">Opmerking King: ${escapeHtml(uv.cKing)}</div>`:''}
        <div>Kut: ${p(uv.kut)}</div>
        ${uv.cKut? `<div class="help">Opmerking Kut: ${escapeHtml(uv.cKut)}</div>`:''}
        <div>Bonanza: ${p(uv.bonanza)}</div>
        ${uv.cBon? `<div class="help">Opmerking Bonanza: ${escapeHtml(uv.cBon)}</div>`:''}`;
    }

    // ======================================================================
    //  INIT & RENDER
    // ======================================================================
    function renderAll(){ renderKPIs(); renderMatches(); renderStats(); renderKlassement(); renderVoting(); if(canSeeAdmin()) renderAdmin(); }
    updateNav(); renderAll();

    // ======================================================================
    //  UTILS
    // ======================================================================
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

</script>
</body>
</html>
